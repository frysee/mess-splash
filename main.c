#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include "fbsplash.h"
#include "svg_parser.h"
#include "svg_renderer.h"
#include "dt_rotation.h"

/*
 * SVG path data for rendering the logo
 */
const char *svg_paths[] = {
    "m 385.28809,336.02663 c -0.0942,-0.003 -0.18884,0.006 -0.28321,0.006 -0.0263,-1.9e-4 -0.0517,-0.004 -0.0781,-0.004 -0.064,0 -0.12577,0.009 -0.18945,0.01 -0.23379,0.005 -0.46692,0.0144 -0.70118,0.0352 -0.2154,0.0175 -0.42711,0.0443 -0.63867,0.0742 -0.099,0.0148 -0.19799,0.0273 -0.29687,0.0449 -5.08353,0.86401 -8.9336,5.25861 -8.9336,10.5957 v 85.62101 c 0,5.96122 4.79855,10.75976 10.75977,10.75976 5.96122,0 10.75976,-4.79854 10.75976,-10.75976 v -40.53906 l 21.33594,42.77343 c 1.51467,2.88344 2.83953,5.4647 5.80664,6.96289 3.44917,1.7416 7.36664,1.45404 10.43164,-0.40625 2.50052,-1.42027 3.86187,-3.61604 5.08008,-6.22656 l 21.5742,-42.91797 v 40.49219 c 0,5.96122 4.79854,10.75977 10.75977,10.75977 5.9612,0 10.76171,-4.79855 10.76171,-10.75977 v -85.62109 c 0,-5.333 -3.84608,-9.72499 -8.92382,-10.59375 -0.0892,-0.0158 -0.17832,-0.0275 -0.26758,-0.041 -0.23133,-0.0336 -0.46327,-0.0633 -0.69922,-0.082 -0.18789,-0.0159 -0.3749,-0.0214 -0.5625,-0.0273 -0.10347,-0.003 -0.20441,-0.0156 -0.30859,-0.0156 -0.0429,0 -0.0842,0.005 -0.12696,0.006 -0.25046,0.002 -0.49942,0.0174 -0.74804,0.0371 -0.10488,0.008 -0.21047,0.014 -0.31446,0.0254 -0.26189,0.0285 -0.52089,0.0697 -0.7793,0.11718 -0.0878,0.0161 -0.17666,0.0286 -0.26367,0.0469 -0.25297,0.0531 -0.50177,0.12036 -0.75,0.19141 -0.0927,0.0265 -0.18761,0.0472 -0.27929,0.0762 -0.25223,0.0796 -0.49837,0.17546 -0.74414,0.27344 -0.0736,0.0294 -0.14984,0.053 -0.22266,0.084 -0.28305,0.12016 -0.55972,0.25607 -0.83203,0.40039 -0.029,0.0154 -0.059,0.0292 -0.0879,0.0449 -0.29374,0.15915 -0.57858,0.33278 -0.85742,0.51953 -0.006,0.004 -0.0132,0.008 -0.0195,0.0117 -0.2844,0.19136 -0.55964,0.3978 -0.82617,0.61719 -0.26423,0.21749 -0.51927,0.44906 -0.76367,0.69336 -0.23769,0.23759 -0.4648,0.48775 -0.68164,0.75 -0.005,0.006 -0.009,0.0118 -0.0137,0.0176 -0.1778,0.21594 -0.34345,0.44361 -0.50586,0.67578 -0.0474,0.0678 -0.0987,0.13226 -0.14453,0.20117 -0.14768,0.22177 -0.2831,0.45388 -0.41602,0.68945 -0.0376,0.0669 -0.079,0.13142 -0.11523,0.19922 -0.0435,0.0809 -0.0931,0.15582 -0.13477,0.23828 L 427.84668,407.8079 394.5752,341.94072 c -1.72742,-3.4197 -5.00854,-5.50821 -8.54493,-5.85743 -0.009,-9e-4 -0.0183,-0.001 -0.0273,-0.002 -0.23756,-0.0229 -0.4754,-0.0478 -0.71484,-0.0547 z m 256.63476,0.11914 c -5.96121,0 -10.75976,4.79854 -10.75976,10.75976 v 85.6211 c 0,5.96121 4.79855,10.75976 10.75976,10.75976 5.96122,0 10.75977,-4.79855 10.75977,-10.75976 v -85.6211 c 0,-5.96122 -4.79855,-10.75976 -10.75977,-10.75976 z m 181.98633,0.0273 c -5.96122,0 -10.76172,4.79854 -10.76172,10.75976 v 85.6211 c 0,5.96121 4.8005,10.76171 10.76172,10.76171 5.96122,0 10.75977,-4.8005 10.75977,-10.76171 v -53.30859 l 44.98632,60.30078 0.0117,-0.01 c 1.96539,2.53046 5.03157,4.16015 8.49805,4.16015 5.96122,0 10.75976,-4.79854 10.75977,-10.75976 v -85.62106 c 0,-5.96122 -4.79855,-10.76172 -10.75977,-10.76172 -5.96122,0 -10.76172,4.8005 -10.76172,10.76172 V 400.636 l -44.76758,-60.00781 -0.006,0.006 c -1.95107,-2.70186 -5.1188,-4.46094 -8.7207,-4.46094 z m -14.02539,171.16211 c -10.04891,0 -18.13867,8.08977 -18.13867,18.13867 v 391.8086 c 0,10.04891 8.08976,18.13867 18.13867,18.13867 h 92.47656 c 10.04891,0 18.13867,-8.08976 18.13867,-18.13867 v -391.8086 c 0,-10.0489 -8.08976,-18.13867 -18.13867,-18.13867 z m -434.10352,0.0742 c -6.80336,0 -12.27929,5.47788 -12.27929,12.28125 v 265.26367 c 0,1.43969 0.29098,2.79851 0.74218,4.08008 a 171.30435,166.07416 0 0 0 170.82227,158.93945 171.30435,166.07416 0 0 0 171.30469,-166.07422 171.30435,166.07416 0 0 0 -0.0723,-1.39843 V 519.69069 c 3e-5,-6.80337 -5.47589,-12.28125 -12.27927,-12.28125 H 589.82324 c -6.80336,0 -12.27929,5.47788 -12.27929,12.28125 V 781.4446 a 42.772274,38.698727 0 0 1 -42.57032,36.45507 42.772274,38.698727 0 0 1 -42.60547,-36.58398 h -0.11328 v -261.625 c 0,-6.80337 -5.47593,-12.28125 -12.27929,-12.28125 z"
};

/* Color definitions for each path component
 */
const char *svg_colors[] = {
    "rgb(255,255,255)",  // White
};

#define NUM_PATHS (sizeof(svg_paths) / sizeof(svg_paths[0]))

/*
 * Main program entry point
 */
int main(void) {
    const char *fb_device = "/dev/fb0";

    // Get rotation from device tree
    int rotation = get_display_rotation();

    // Check framebuffer device accessibility
    if (access(fb_device, R_OK | W_OK) != 0) {
        fprintf(stderr, "Cannot access %s: %s\n", fb_device, strerror(errno));
        return 1;
    }

    // Initialize framebuffer
    Framebuffer *fb = fb_init(fb_device);
    if (!fb) {
        fprintf(stderr, "Failed to initialize framebuffer\n");
        return 1;
    }

    // Calculate display parameters
    DisplayInfo *display_info = calculate_display_info(fb);
    if (!display_info) {
        fprintf(stderr, "Failed to calculate display information\n");
        fb_cleanup(fb);
        return 1;
    }

    // Clear screen to black
    for (uint32_t y = 0; y < fb->vinfo.yres; y++) {
        for (uint32_t x = 0; x < fb->vinfo.xres; x++) {
            set_pixel(fb, x, y, 0x00000000);
        }
    }

    // Process and render each path component
    for (size_t i = 0; i < NUM_PATHS; i++) {
        SVGPath *svg = parse_svg_path(svg_paths[i], svg_colors[i]);
        if (!svg) {
            fprintf(stderr, "Failed to parse SVG path %zu\n", i);
            continue;
        }

        // Apply rotation from device tree if specified
        if (rotation)
            rotate_svg_path(svg, rotation);

        // Render the path
        render_svg_path(fb, svg, display_info);
        free_svg_path(svg);
    }

    // Clean up
    free(display_info);
    fb_cleanup(fb);

    return 0;
}
