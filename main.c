#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include "fbsplash.h"
#include "svg_parser.h"
#include "svg_renderer.h"
#include "dt_rotation.h"

/*
 * SVG path data for rendering the logo
 */
const char *svg_paths[] = {
    "M 716,925.90831 C 713.8847,925.99231 711.7681,926.69111 709.9258,928.04311 705.0128,931.64861 703.9609,938.50511 707.5664,943.41811 L 734.4433,980.04111 707.5664,1016.6662 C 703.9609,1021.5791 705.0128,1028.4377 709.9257,1032.0431 714.8388,1035.6486 721.6973,1034.5948 725.3027,1029.6818 L 748.0879,998.63491 770.8711,1029.6818 C 774.4765,1034.5948 781.335,1035.6485 786.248,1032.0431 791.161,1028.4376 792.2128,1021.5791 788.6074,1016.6661 L 761.7305,980.04121 788.6074,943.41811 C 792.2128,938.50511 791.161,931.64861 786.248,928.04311 781.335,924.43761 774.4765,925.48951 770.8711,930.40251 L 748.0878,961.44931 725.3027,930.40251 C 723.0493,927.33191 719.5254,925.76831 716,925.90831 Z",
    "M 502,925.90831 C 495.906,925.90831 491,930.81431 491,936.90831 V 979.90831 1022.9083 C 491,1029.0023 495.906,1033.9083 502,1033.9083 H 566 C 572.094,1033.9083 577,1029.0023 577,1022.9083 577,1016.8143 572.094,1011.9083 566,1011.9083 H 513 V 990.90831 H 544 C 550.094,990.90831 555,986.00231 555,979.90831 555,973.81431 550.094,968.90831 544,968.90831 H 513 V 947.90831 H 566 C 572.094,947.90831 577,943.00231 577,936.90831 577,930.81431 572.094,925.90831 566,925.90831 Z",
    "M 812,421.90831 H 900 C 911.08,421.90831 920,430.82831 920,441.90831 V 841.90831 C 920,852.98831 911.08,861.90831 900,861.90831 H 812 C 800.92,861.90831 792,852.98831 792,841.90831 V 441.90831 C 792,430.82831 800.92,421.90831 812,421.90831 Z",
    "M 384,421.90831 C 372.92,421.90831 364,430.82831 364,441.90831 V 593.90831 691.90831 C 364,786.08831 439.82,861.90831 534,861.90831 628.18,861.90831 704,786.08831 704,691.90831 V 499.90831 441.90831 C 704,430.82831 695.08,421.90831 684,421.90831 H 596 C 584.92,421.90831 576,430.82831 576,441.90831 V 593.90831 691.90831 C 576,715.17631 557.268,733.90831 534,733.90831 510.732,733.90831 492,715.17631 492,691.90831 V 499.90831 441.90831 C 492,430.82831 483.08,421.90831 472,421.90831 Z",
    "M 824,249.90831 C 823.9182,249.90831 823.83922,249.91831 823.75781,249.92001 823.58253,249.92401 823.40765,249.93471 823.23242,249.94731 823.01176,249.96251 822.79299,249.98191 822.57617,250.00981 822.48277,250.02221 822.39006,250.03791 822.29688,250.05281 822.00186,250.09841 821.71047,250.15241 821.42383,250.22078 821.40943,250.22478 821.39523,250.22878 821.38083,250.23248 817.42335,251.19408 814.3239,254.27817 813.33981,258.22662 813.32941,258.26772 813.31851,258.30842 813.30861,258.34967 813.24501,258.61799 813.19404,258.89041 813.15041,259.16607 813.13391,259.26768 813.11721,259.36873 813.10351,259.47076 813.07551,259.68636 813.05451,259.90369 813.03901,260.1231 813.02621,260.29738 813.01821,260.47169 813.01361,260.64654 813.01161,260.73444 812.99991,260.8198 812.99991,260.90826 V 346.90826 C 812.99991,353.00226 817.90591,357.90826 823.99991,357.90826 830.09391,357.90826 834.99991,353.00226 834.99991,346.90826 V 294.13482 L 879.14444,353.46099 C 879.22294,353.56649 879.31104,353.6599 879.39249,353.76178 879.47319,353.86317 879.55632,353.96219 879.64053,354.0606 879.78458,354.22853 879.93195,354.39163 880.08389,354.54888 880.18149,354.64998 880.28134,354.74847 880.38272,354.84576 880.54666,355.00298 880.71305,355.15543 880.88468,355.30084 880.98118,355.38264 881.08031,355.46066 881.1796,355.53912 881.35493,355.67753 881.53074,355.81301 881.7128,355.93951 881.82908,356.02041 881.94875,356.09544 882.06827,356.17193 882.24662,356.28584 882.42563,356.39722 882.60929,356.50006 882.74068,356.57376 882.87498,356.64256 883.00968,356.71099 883.18642,356.80059 883.36414,356.88726 883.54483,356.96685 883.6925,357.03205 883.84301,357.09161 883.99405,357.15045 884.17726,357.22165 884.36045,357.29049 884.54679,357.35162 884.69431,357.40012 884.8438,357.44202 884.99405,357.48443 885.19186,357.54013 885.38937,357.59422 885.58975,357.63873 885.74007,357.67213 885.89223,357.69943 886.04483,357.72663 886.24545,357.76243 886.44606,357.79383 886.64835,357.81843 886.80425,357.83743 886.96116,357.85093 887.11905,357.86333 887.32574,357.87953 887.53264,357.89013 887.74014,357.89453 887.82744,357.89653 887.91211,357.90823 887.99991,357.90823 888.08171,357.90823 888.16069,357.89823 888.2421,357.89653 888.41738,357.89253 888.59226,357.88183 888.76749,357.86923 888.98815,357.85403 889.20692,357.83463 889.42374,357.80673 889.51714,357.79433 889.60985,357.77863 889.70303,357.76373 889.99805,357.71813 890.28944,357.66413 890.57608,357.59576 890.58208,357.59476 890.58778,357.59376 890.59368,357.59176 890.60268,357.58976 890.61048,357.58576 890.61908,357.58376 894.57595,356.62231 897.6755,353.53914 898.6601,349.59157 898.6707,349.54997 898.6813,349.50837 898.6913,349.46657 898.7549,349.19825 898.80587,348.92583 898.8495,348.65017 898.866,348.54856 898.8827,348.44751 898.8964,348.34548 898.9244,348.12988 898.9454,347.91255 898.9609,347.69314 898.9738,347.5187 898.9817,347.34471 898.9863,347.1697 898.9883,347.0818 899,346.99644 899,346.90798 V 260.90798 C 899,254.81398 894.094,249.90798 888,249.90798 881.906,249.90798 877,254.81398 877,260.90798 V 313.68142 L 832.85547,254.35525 C 832.77697,254.24975 832.68887,254.15634 832.60742,254.05446 832.52672,253.95307 832.44359,253.85405 832.35938,253.75564 832.21533,253.58771 832.06796,253.42461 831.91602,253.26736 831.81842,253.16626 831.71857,253.06777 831.61719,252.97048 831.45325,252.81326 831.28686,252.66081 831.11523,252.5154 831.01873,252.4336 830.9196,252.35558 830.82031,252.27712 830.64498,252.13871 830.46917,252.00323 830.28711,251.87673 830.17083,251.79583 830.05116,251.7208 829.93164,251.64431 829.75329,251.5304 829.57428,251.41902 829.39062,251.31618 829.25923,251.24248 829.12493,251.17368 828.99023,251.10525 828.81349,251.01565 828.63577,250.92898 828.45508,250.84939 828.30741,250.78419 828.1569,250.72463 828.00586,250.66579 827.82265,250.59459 827.63946,250.52575 827.45312,250.46462 827.3056,250.41612 827.15611,250.37422 827.00586,250.33181 826.80805,250.27611 826.61054,250.22202 826.41016,250.17751 826.25984,250.14411 826.10768,250.11681 825.95508,250.08961 825.75446,250.05381 825.55385,250.02241 825.35156,249.99781 825.19566,249.97881 825.03875,249.96531 824.88086,249.95291 824.67417,249.93671 824.46727,249.92611 824.25977,249.92171 824.17247,249.91971 824.0878,249.90801 824,249.90801 Z",
    "M 640,249.90831 C 646.094,249.90831 651,254.81431 651,260.90831 V 346.90831 C 651,353.00231 646.094,357.90831 640,357.90831 633.906,357.90831 629,353.00231 629,346.90831 V 260.90831 C 629,254.81431 633.906,249.90831 640,249.90831 Z",
    "M 385.33203,249.82237 C 383.57753,249.75997 381.77862,250.12446 380.08594,250.96886 376.19278,252.91097 373.96432,256.84375 374,260.92003 V 346.90831 C 374,353.00231 378.906,357.90831 385,357.90831 391.094,357.90831 396,353.00231 396,346.90831 V 308.33019 L 417.33398,351.91026 C 419.28973,355.9055 423.31947,358.14552 427.46875,357.98448 431.97399,358.60392 436.53196,356.33556 438.65234,352.00401 L 460,308.39659 V 346.90831 C 460,353.00231 464.906,357.90831 471,357.90831 477.094,357.90831 482,353.00231 482,346.90831 V 260.90831 C 482,260.84161 481.991,260.77742 481.99,260.71104 481.986,260.51567 481.9747,260.32135 481.9607,260.12706 481.9476,259.93896 481.9323,259.75183 481.9099,259.56651 481.8934,259.43362 481.8726,259.30206 481.8513,259.17003 481.8134,258.93005 481.7715,258.6916 481.71849,258.45714 481.70209,258.38554 481.68159,258.31546 481.66379,258.24425 481.59219,257.95508 481.51348,257.67023 481.41965,257.39073 481.4188,257.38773 481.41865,257.38573 481.41765,257.38273 481.41465,257.37473 481.41065,257.36733 481.40765,257.35933 480.95093,256.01244 480.24391,254.78566 479.33734,253.73238 479.10401,253.46129 478.85752,253.20201 478.59906,252.95504 478.33774,252.70533 478.06379,252.46914 477.77875,252.24605 477.48988,252.01997 477.18955,251.80995 476.87836,251.61324 476.56611,251.41586 476.24422,251.23405 475.91156,251.06832 475.90756,251.06632 475.90356,251.06432 475.89986,251.06232 475.89286,251.05832 475.88556,251.05632 475.87836,251.05232 475.57488,250.90239 475.26346,250.76611 474.94476,250.64412 474.88046,250.61922 474.81589,250.59732 474.7514,250.57382 474.4978,250.48212 474.24193,250.39701 473.97992,250.32382 473.84683,250.28612 473.71313,250.25472 473.57953,250.22225 473.38371,250.17545 473.18753,250.13155 472.98773,250.0953 472.79814,250.0604 472.60929,250.0339 472.41937,250.0094 472.26114,249.9891 472.10312,249.9682 471.94281,249.9547 471.73065,249.9368 471.51972,249.9287 471.30804,249.9234 471.20446,249.9204 471.10375,249.9078 470.99945,249.9078 470.94265,249.9078 470.88803,249.9148 470.83148,249.9158 470.66549,249.9188 470.50056,249.9304 470.33539,249.9412 470.09577,249.9554 469.85765,249.9726 469.6225,250.0018 469.6081,250.0038 469.594,250.0078 469.5795,250.0098 465.22311,250.56815 461.68044,253.64741 460.46036,257.75394 L 428.01758,324.03331 395.5,257.61143 C 394.76707,255.26119 393.26595,253.25832 391.29297,251.88292 389.55471,250.61925 387.47804,249.89872 385.33203,249.82237 Z"};

/* Color definitions for each path component
 */
const char *svg_colors[] = {
    "rgb(155,34,86)",    // DMG red
    "rgb(155,34,86)"     // DMG red
    "rgb(255Â ,255,255)", // White
    "rgb(255,255,255)",  // White
    "rgb(255,255,255)",  // White
    "rgb(255,255,255)",  // White
    "rgb(255,255,255)"   // White
};

#define NUM_PATHS (sizeof(svg_paths) / sizeof(svg_paths[0]))

/*
 * Main program entry point
 */
int main(void)
{
    const char *fb_device = "/dev/fb0";

    // Get rotation from device tree
    int rotation = get_display_rotation();

    // Check framebuffer device accessibility
    if (access(fb_device, R_OK | W_OK) != 0)
    {
        fprintf(stderr, "Cannot access %s: %s\n", fb_device, strerror(errno));
        return 1;
    }

    // Initialize framebuffer
    Framebuffer *fb = fb_init(fb_device);
    if (!fb)
    {
        fprintf(stderr, "Failed to initialize framebuffer\n");
        return 1;
    }

    // Calculate display parameters
    DisplayInfo *display_info = calculate_display_info(fb);
    if (!display_info)
    {
        fprintf(stderr, "Failed to calculate display information\n");
        fb_cleanup(fb);
        return 1;
    }

    // Clear screen to black
    for (uint32_t y = 0; y < fb->vinfo.yres; y++)
    {
        for (uint32_t x = 0; x < fb->vinfo.xres; x++)
        {
            set_pixel(fb, x, y, 0x00000000);
        }
    }

    // Process and render each path component
    for (size_t i = 0; i < NUM_PATHS; i++)
    {
        SVGPath *svg = parse_svg_path(svg_paths[i], svg_colors[i]);
        if (!svg)
        {
            fprintf(stderr, "Failed to parse SVG path %zu\n", i);
            continue;
        }

        // Apply rotation from device tree if specified
        if (rotation)
            rotate_svg_path(svg, rotation);

        // Render the path
        render_svg_path(fb, svg, display_info);
        free_svg_path(svg);
    }

    // Clean up
    free(display_info);
    fb_cleanup(fb);

    return 0;
}
