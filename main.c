#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include "fbsplash.h"
#include "svg_parser.h"
#include "svg_renderer.h"
#include "dt_rotation.h"

/*
 * SVG path data for rendering the logo
 */
const char *svg_paths[] = {
    "M 809.88379,507.33518 C 799.83488,507.33518 791.74512,515.42495 791.74512,525.47385 V 917.28245 C 791.74512,927.33136 799.83488,935.42112 809.88379,935.42112 H 902.36035 C 912.40926,935.42112 920.49902,927.33136 920.49902,917.28245 V 525.47385 C 920.49902,515.42495 912.40926,507.33518 902.36035,507.33518 Z",
    "M 375.78027,507.40938 C 368.97691,507.40938 363.50098,512.88726 363.50098,519.69063 V 784.9543 C 363.50098,786.39399 363.79196,787.75281 364.24316,789.03438 368.17914,877.77628 443.44436,947.80586 535.06543,947.97383 629.67437,947.97401 706.37015,873.61999 706.37012,781.89961 706.34805,781.43337 706.32395,780.96722 706.29782,780.50118 V 519.69069 C 706.29785,512.88732 700.82193,507.40944 694.01855,507.40944 H 589.82324 C 583.01988,507.40944 577.54395,512.88732 577.54395,519.69069 V 781.4446 C 576.23323,801.86607 557.58265,817.83749 534.97363,817.89967 512.29907,817.85032 493.60718,801.80018 492.36816,781.31569 H 492.25488 V 519.69069 C 492.25488,512.88732 486.77895,507.40944 479.97559,507.40944 Z",
    "M 823.90918,336.17307 C 817.94796,336.17307 813.14746,340.97161 813.14746,346.93283 V 432.55393 C 813.14746,438.51514 817.94796,443.31564 823.90918,443.31564 829.8704,443.31564 834.66895,438.51514 834.66895,432.55393 V 379.24534 L 879.65527,439.54612 879.66697,439.53612 C 881.63236,442.06658 884.69854,443.69627 888.16502,443.69627 894.12624,443.69627 898.92478,438.89773 898.92479,432.93651 V 347.31545 C 898.92479,341.35423 894.12624,336.55373 888.16502,336.55373 882.2038,336.55373 877.4033,341.35423 877.4033,347.31545 V 400.636 L 832.63572,340.62819 832.62972,340.63419 C 830.67865,337.93233 827.51092,336.17325 823.90902,336.17325 Z",
    "M 641.92285,336.14577 C 635.96164,336.14577 631.16309,340.94431 631.16309,346.90553 V 432.52663 C 631.16309,438.48784 635.96164,443.28639 641.92285,443.28639 647.88407,443.28639 652.68262,438.48784 652.68262,432.52663 V 346.90553 C 652.68262,340.94431 647.88407,336.14577 641.92285,336.14577 Z",
    "M 385.28809,336.02663 C 385.19389,336.02363 385.09925,336.03263 385.00488,336.03263 384.97858,336.03244 384.95318,336.02863 384.92678,336.02863 384.86278,336.02863 384.80101,336.03763 384.73733,336.03863 384.50354,336.04363 384.27041,336.05303 384.03615,336.07383 383.82075,336.09133 383.60904,336.11813 383.39748,336.14803 383.29848,336.16283 383.19949,336.17533 383.10061,336.19293 378.01708,337.05694 374.16701,341.45154 374.16701,346.78863 V 432.40964 C 374.16701,438.37086 378.96556,443.1694 384.92678,443.1694 390.888,443.1694 395.68654,438.37086 395.68654,432.40964 V 391.87058 L 417.02248,434.64401 C 418.53715,437.52745 419.86201,440.10871 422.82912,441.6069 426.27829,443.3485 430.19576,443.06094 433.26076,441.20065 435.76128,439.78038 437.12263,437.58461 438.34084,434.97409 L 459.91504,392.05612 V 432.54831 C 459.91504,438.50953 464.71358,443.30808 470.67481,443.30808 476.63601,443.30808 481.43652,438.50953 481.43652,432.54831 V 346.92722 C 481.43652,341.59422 477.59044,337.20223 472.5127,336.33347 472.4235,336.31767 472.33438,336.30597 472.24512,336.29247 472.01379,336.25887 471.78185,336.22917 471.5459,336.21047 471.35801,336.19457 471.171,336.18907 470.9834,336.18317 470.87993,336.18017 470.77899,336.16757 470.67481,336.16757 470.63191,336.16757 470.59061,336.17257 470.54785,336.17357 470.29739,336.17557 470.04843,336.19097 469.79981,336.21067 469.69493,336.21867 469.58934,336.22467 469.48535,336.23607 469.22346,336.26457 468.96446,336.30577 468.70605,336.35325 468.61825,336.36935 468.52939,336.38185 468.44238,336.40015 468.18941,336.45325 467.94061,336.52051 467.69238,336.59156 467.59968,336.61806 467.50477,336.63876 467.41309,336.66776 467.16086,336.74736 466.91472,336.84322 466.66895,336.9412 466.59535,336.9706 466.51911,336.9942 466.44629,337.0252 466.16324,337.14536 465.88657,337.28127 465.61426,337.42559 465.58526,337.44099 465.55526,337.45479 465.52636,337.47049 465.23262,337.62964 464.94778,337.80327 464.66894,337.99002 464.66294,337.99402 464.65574,337.99802 464.64944,338.00172 464.36504,338.19308 464.0898,338.39952 463.82327,338.61891 463.55904,338.8364 463.304,339.06797 463.0596,339.31227 462.82191,339.54986 462.5948,339.80002 462.37796,340.06227 462.37296,340.06827 462.36896,340.07407 462.36426,340.07987 462.18646,340.29581 462.02081,340.52348 461.8584,340.75565 461.811,340.82345 461.7597,340.88791 461.71387,340.95682 461.56619,341.17859 461.43077,341.4107 461.29785,341.64627 461.26025,341.71317 461.21885,341.77769 461.18262,341.84549 461.13912,341.92639 461.08952,342.00131 461.04785,342.08377 L 427.84668,407.8079 394.5752,341.94072 C 392.84778,338.52102 389.56666,336.43251 386.03027,336.08329 386.02127,336.08239 386.01197,336.08229 386.00297,336.08129 385.76541,336.05839 385.52757,336.03349 385.28813,336.02659 Z",

    /* Color definitions for each path component
     */
    const char *svg_colors[] = {
        "rgb(255,255,255)", // White
        "rgb(255,255,255)", // White
        "rgb(255,255,255)", // White
        "rgb(255,255,255)", // White
        "rgb(255,255,255)"  // White
    };

#define NUM_PATHS (sizeof(svg_paths) / sizeof(svg_paths[0]))

/*
 * Main program entry point
 */
int main(void)
{
    const char *fb_device = "/dev/fb0";

    // Get rotation from device tree
    int rotation = get_display_rotation();

    // Check framebuffer device accessibility
    if (access(fb_device, R_OK | W_OK) != 0)
    {
        fprintf(stderr, "Cannot access %s: %s\n", fb_device, strerror(errno));
        return 1;
    }

    // Initialize framebuffer
    Framebuffer *fb = fb_init(fb_device);
    if (!fb)
    {
        fprintf(stderr, "Failed to initialize framebuffer\n");
        return 1;
    }

    // Calculate display parameters
    DisplayInfo *display_info = calculate_display_info(fb);
    if (!display_info)
    {
        fprintf(stderr, "Failed to calculate display information\n");
        fb_cleanup(fb);
        return 1;
    }

    // Clear screen to black
    for (uint32_t y = 0; y < fb->vinfo.yres; y++)
    {
        for (uint32_t x = 0; x < fb->vinfo.xres; x++)
        {
            set_pixel(fb, x, y, 0x00000000);
        }
    }

    // Process and render each path component
    for (size_t i = 0; i < NUM_PATHS; i++)
    {
        SVGPath *svg = parse_svg_path(svg_paths[i], svg_colors[i]);
        if (!svg)
        {
            fprintf(stderr, "Failed to parse SVG path %zu\n", i);
            continue;
        }

        // Apply rotation from device tree if specified
        if (rotation)
            rotate_svg_path(svg, rotation);

        // Render the path
        render_svg_path(fb, svg, display_info);
        free_svg_path(svg);
    }

    // Clean up
    free(display_info);
    fb_cleanup(fb);

    return 0;
}
